# üîí –ë–µ–∑–ø–µ–∫–∞ Minesweeper Online ‚Äî Appwrite Functions

## –û–≥–ª—è–¥ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–∏—Ö –∑–º—ñ–Ω

### –ü—Ä–æ–±–ª–µ–º–∞ (–ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω)

–í—Å—è —ñ–≥—Ä–æ–≤–∞ –ª–æ–≥—ñ–∫–∞ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è **–Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ**. –¶–µ –æ–∑–Ω–∞—á–∞—î:

- üî¥ –ì—Ä–∞–≤—Ü—ñ –±–∞—á–∞—Ç—å –ø–æ–∑–∏—Ü—ñ—ó –º—ñ–Ω —á–µ—Ä–µ–∑ DevTools (–ø–æ–ª–µ `board` –º—ñ—Å—Ç–∏—Ç—å `isMine: true`)
- üî¥ –ë—É–¥—å-—Ö—Ç–æ –º–æ–∂–µ –∑–º—ñ–Ω–∏—Ç–∏ —Å–≤—ñ–π —Ä–∞—Ö—É–Ω–æ–∫ –Ω–∞–ø—Ä—è–º—É –≤ –±–∞–∑—ñ (`Permission.update(Role.users())`)
- üî¥ –ú–æ–∂–Ω–∞ —Ö–æ–¥–∏—Ç–∏ –∑–∞ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è
- üî¥ –ü–∞—Ä–æ–ª—ñ –ª–æ–±—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —É –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É –≤–∏–≥–ª—è–¥—ñ
- üî¥ –ú–æ–∂–Ω–∞ –æ–≥–æ–ª–æ—Å–∏—Ç–∏ —Å–µ–±–µ –ø–µ—Ä–µ–º–æ–∂—Ü–µ–º

### –†—ñ—à–µ–Ω–Ω—è

–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ **–≤—Å—é –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫—É** –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ **Appwrite Functions**:

```
–ö–ª—ñ—î–Ω—Ç ‚Üí Appwrite Function ‚Üí Appwrite Database
              ‚Üì
         –í–∞–ª—ñ–¥–∞—Ü—ñ—è + –ª–æ–≥—ñ–∫–∞
              ‚Üì
         –ë–µ–∑–ø–µ—á–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (–±–µ–∑ –º—ñ–Ω)
```

---

## –ö—Ä–æ–∫ 1: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è API –∫–ª—é—á–∞

1. Appwrite Console ‚Üí **Settings** ‚Üí **API Keys**
2. –°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π –∫–ª—é—á —ñ–∑ –ø—Ä–∞–≤–∞–º–∏:
   - `databases.read`
   - `databases.write`
   - `users.read`
3. –°–∫–æ–ø—ñ—é–π—Ç–µ –∫–ª—é—á ‚Äî –≤—ñ–Ω –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è –¥–ª—è —Ñ—É–Ω–∫—Ü—ñ–π

---

## –ö—Ä–æ–∫ 2: –ó–º—ñ–Ω–∏—Ç–∏ –¥–æ–∑–≤–æ–ª–∏ –∫–æ–ª–µ–∫—Ü—ñ–π

### –ö–æ–ª–µ–∫—Ü—ñ—è `lobbies`:

```
Collection-level permissions:
  - Users: ‚úÖ Create, ‚úÖ Read, ‚ùå Update, ‚ùå Delete

Document-level permissions (Document Security = ON):
  - –ö–æ–∂–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —Ñ—É–Ω–∫—Ü—ñ—î—é –∑:
    - Permission.read(Role.users())
    - Permission.delete(Role.user(hostId))  // —Ç—ñ–ª—å–∫–∏ —Ö–æ—Å—Ç –º–æ–∂–µ –≤–∏–¥–∞–ª–∏—Ç–∏
    - –ù–ï –¥–æ–¥–∞–≤–∞—Ç–∏ Permission.update –¥–ª—è users!
```

### –ö–æ–ª–µ–∫—Ü—ñ—è `games`:

```
Collection-level permissions:
  - Users: ‚ùå Create, ‚úÖ Read, ‚ùå Update, ‚ùå Delete

Document-level permissions (Document Security = ON):
  - –ö–æ–∂–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è —Ñ—É–Ω–∫—Ü—ñ—î—é –∑:
    - Permission.read(Role.users())
    - Permission.delete(Role.user(hostId))
    - –ù–ï –¥–æ–¥–∞–≤–∞—Ç–∏ Permission.update –¥–ª—è users!
```

> ‚ùó **–ö–†–ò–¢–ò–ß–ù–û**: –ü—Ä–∏–±—Ä–∞—Ç–∏ `Permission.update(Role.users())` –∑ –æ–±–æ—Ö –∫–æ–ª–µ–∫—Ü—ñ–π!
> –§—É–Ω–∫—Ü—ñ—ó –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å API key, —è–∫–∏–π –æ–±—Ö–æ–¥–∏—Ç—å –¥–æ–∑–≤–æ–ª–∏. –ö–ª—ñ—î–Ω—Ç –±—ñ–ª—å—à–µ –Ω–µ –º–æ–∂–µ
> –Ω–∞–ø—Ä—è–º—É –º–æ–¥–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏.

---

## –ö—Ä–æ–∫ 3: –î–æ–¥–∞—Ç–∏ –∞—Ç—Ä–∏–±—É—Ç `passwordSalt` –¥–æ –∫–æ–ª–µ–∫—Ü—ñ—ó `lobbies`

| Attribute    | Type   | Size | Required | Default |
| ------------ | ------ | ---- | -------- | ------- |
| passwordSalt | string | 100  | No       | null    |

---

## –ö—Ä–æ–∫ 4: –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–π

### –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Appwrite CLI:

```bash
npm install -g appwrite-cli
appwrite login
```

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–π –≤ –∫–æ–Ω—Å–æ–ª—ñ:

–î–ª—è –∫–æ–∂–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó –∑ –ø–∞–ø–∫–∏ `functions/`:

1. **Appwrite Console ‚Üí Functions ‚Üí Create Function**
2. **Runtime**: Node.js 18.0+
3. **Function ID**: –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —ñ–º'—è –ø–∞–ø–∫–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `game-make-move`)

### –ó–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –¥–ª—è –∫–æ–∂–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó:

```
APPWRITE_API_KEY = <–≤–∞—à API –∫–ª—é—á>
DATABASE_ID = minesweeper_db
GAMES_COLLECTION_ID = games
LOBBIES_COLLECTION_ID = lobbies
```

> –ó–º—ñ–Ω–Ω—ñ `APPWRITE_FUNCTION_API_ENDPOINT` —Ç–∞ `APPWRITE_FUNCTION_PROJECT_ID`
> –≤—Å—Ç–∞–Ω–æ–≤–ª—é—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ Appwrite.

### –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è —á–µ—Ä–µ–∑ CLI:

```bash
# –ó –∫–æ—Ä–µ–Ω–µ–≤–æ—ó –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç—É
cd functions/game-make-move
npm install
appwrite functions createDeployment \
  --functionId=game-make-move \
  --entrypoint=src/main.js \
  --code=.
```

–ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ –¥–ª—è –≤—Å—ñ—Ö —Ñ—É–Ω–∫—Ü—ñ–π:

- `game-make-move`
- `game-make-race-move`
- `game-start`
- `lobby-create`
- `lobby-join`
- `lobby-leave`
- `game-leave`
- `cleanup-stale`

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è CRON –¥–ª—è `cleanup-stale`:

1. Functions ‚Üí `cleanup-stale` ‚Üí Settings
2. Schedule: `*/15 * * * *` (–∫–æ–∂–Ω—ñ 15 —Ö–≤–∏–ª–∏–Ω)

---

## –ö—Ä–æ–∫ 5: –û–Ω–æ–≤–∏—Ç–∏ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π –∫–æ–¥

–ó–∞–º—ñ–Ω–∏—Ç–∏ —ñ–º–ø–æ—Ä—Ç —É –≤—Å—ñ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö:

```typescript
// –ë–£–õ–û:
import { createLobby, joinLobby, ... } from '../multiplayerService';

// –°–¢–ê–õ–û:
import { createLobby, joinLobby, ... } from '../multiplayerServiceSecure';
```

–§–∞–π–ª–∏, —è–∫—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ–Ω–æ–≤–∏—Ç–∏:

- `src/components/multiplayer/CreateLobby.tsx`
- `src/components/multiplayer/LobbyRoom.tsx`
- `src/components/multiplayer/MultiplayerGame.tsx`
- `src/components/multiplayer/RaceGame.tsx`
- `src/components/multiplayer/LobbyList.tsx`
- `src/components/multiplayer/MultiplayerApp.tsx`

–ê–±–æ –ø—Ä–æ—Å—Ç—ñ—à–µ ‚Äî –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞—Ç–∏:

```bash
mv src/multiplayerService.ts src/multiplayerService.old.ts
mv src/multiplayerServiceSecure.ts src/multiplayerService.ts
```

---

## –ö—Ä–æ–∫ 6: –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ø–æ–ª–µ `board` –≤—ñ–¥ –∫–ª—ñ—î–Ω—Ç—ñ–≤

### –í–∞—Ä—ñ–∞–Ω—Ç A: –í–∏–¥–∞–ª–∏—Ç–∏ `board` –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ `getGame()`

–°—Ç–≤–æ—Ä–∏—Ç–∏ —â–µ –æ–¥–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é `game-get-state` —è–∫–∞ –ø–æ–≤–µ—Ä—Ç–∞—î –≥—Ä—É **–±–µ–∑ –ø–æ–ª—è board**
–∞–±–æ –∑ –±–µ–∑–ø–µ—á–Ω–∏–º board (–¥–µ `isMine` –∑–∞–≤–∂–¥–∏ `false` –¥–ª—è –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏—Ö –∫–ª—ñ—Ç–∏–Ω–æ–∫).

### –í–∞—Ä—ñ–∞–Ω—Ç B (–ø—Ä–æ—Å—Ç—ñ—à–µ): –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ –¥–≤–∞ –æ–∫—Ä–µ–º—ñ –ø–æ–ª—è

- `board` ‚Äî –ø–æ–≤–Ω–µ –ø–æ–ª–µ –∑ –º—ñ–Ω–∞–º–∏ (—Ç—ñ–ª—å–∫–∏ —Å–µ—Ä–≤–µ—Ä —á–∏—Ç–∞—î —á–µ—Ä–µ–∑ API key)
- `safeBoard` ‚Äî –ø–æ–ª–µ –±–µ–∑ –º—ñ–Ω (–∫–ª—ñ—î–Ω—Ç–∏ —á–∏—Ç–∞—é—Ç—å)

–î–æ–¥–∞–π—Ç–µ –∞—Ç—Ä–∏–±—É—Ç `safeBoard` (string, 1000000) –¥–æ –∫–æ–ª–µ–∫—Ü—ñ—ó `games`.
–°–µ—Ä–≤–µ—Ä –æ–Ω–æ–≤–ª—é—î `safeBoard` –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ö–æ–¥—É.

---

## –ú–∞—Ç—Ä–∏—Ü—è –±–µ–∑–ø–µ–∫–∏

| –û–ø–µ—Ä–∞—Ü—ñ—è            | –†–∞–Ω—ñ—à–µ (–∫–ª—ñ—î–Ω—Ç)            | –¢–µ–ø–µ—Ä (—Å–µ—Ä–≤–µ—Ä)                             |
| ------------------- | -------------------------- | ------------------------------------------ |
| –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–æ–±—ñ      | ‚ùå –ö–ª—ñ—î–Ω—Ç —Å—Ç–≤–æ—Ä—é—î –¥–æ–∫—É–º–µ–Ω—Ç | ‚úÖ –§—É–Ω–∫—Ü—ñ—è `lobby-create`                  |
| –ü—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ –ª–æ–±—ñ  | ‚ùå –ö–ª—ñ—î–Ω—Ç –æ–Ω–æ–≤–ª—é—î –¥–æ–∫—É–º–µ–Ω—Ç | ‚úÖ –§—É–Ω–∫—Ü—ñ—è `lobby-join`                    |
| –í–∏—Ö—ñ–¥ –∑ –ª–æ–±—ñ        | ‚ùå –ö–ª—ñ—î–Ω—Ç –≤–∏–¥–∞–ª—è—î/–æ–Ω–æ–≤–ª—é—î  | ‚úÖ –§—É–Ω–∫—Ü—ñ—è `lobby-leave`                   |
| –°—Ç–∞—Ä—Ç –≥—Ä–∏           | ‚ùå –ö–ª—ñ—î–Ω—Ç –≥–µ–Ω–µ—Ä—É—î –¥–æ—à–∫—É    | ‚úÖ –§—É–Ω–∫—Ü—ñ—è `game-start` (–¥–æ—à–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ) |
| –•—ñ–¥ —É –≥—Ä—ñ           | ‚ùå –ö–ª—ñ—î–Ω—Ç —Ä–∞—Ö—É—î –±–∞–ª–∏       | ‚úÖ –§—É–Ω–∫—Ü—ñ—è `game-make-move`                |
| –•—ñ–¥ —É race          | ‚ùå –ö–ª—ñ—î–Ω—Ç —Ä–∞—Ö—É—î –±–∞–ª–∏       | ‚úÖ –§—É–Ω–∫—Ü—ñ—è `game-make-race-move`           |
| –ó–¥–∞—á–∞ –≥—Ä–∏           | ‚ùå –ö–ª—ñ—î–Ω—Ç —Å—Ç–∞–≤–∏—Ç—å winner   | ‚úÖ –§—É–Ω–∫—Ü—ñ—è `game-leave`                    |
| –ü–∞—Ä–æ–ª—å –ª–æ–±—ñ         | ‚ùå –í—ñ–¥–∫—Ä–∏—Ç–∏–π —Ç–µ–∫—Å—Ç         | ‚úÖ SHA-256 –∑ —Å–æ–ª—å—é                         |
| –ü–æ–∑–∏—Ü—ñ—ó –º—ñ–Ω         | ‚ùå –í–∏–¥–Ω–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ñ       | ‚úÖ –¢—ñ–ª—å–∫–∏ —Å–µ—Ä–≤–µ—Ä –±–∞—á–∏—Ç—å                    |
| –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ –±–∞–ª—ñ–≤    | ‚ùå –ö–ª—ñ—î–Ω—Ç —Ä–∞—Ö—É—î            | ‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞—Ö—É—î                            |
| –ß–µ—Ä–≥–æ–≤—ñ—Å—Ç—å —Ö–æ–¥—ñ–≤    | ‚ùå –ö–ª—ñ—î–Ω—Ç –ø–µ—Ä–µ–≤—ñ—Ä—è—î        | ‚úÖ –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≤—ñ—Ä—è—î                        |
| –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞–ª–∏—Ö –ª–æ–±—ñ | ‚ùå –ù–µ–º–∞—î                   | ‚úÖ CRON `cleanup-stale`                    |

---

## –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó

### Rate limiting

–£–≤—ñ–º–∫–Ω—ñ—Ç—å –ª—ñ–º—ñ—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–π –≤ Appwrite Console:

- `game-make-move`: –º–∞–∫—Å. 60 –≤–∏–∫–æ–Ω–∞–Ω—å/—Ö–≤–∏–ª–∏–Ω—É –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- `lobby-create`: –º–∞–∫—Å. 5 –≤–∏–∫–æ–Ω–∞–Ω—å/—Ö–≤–∏–ª–∏–Ω—É –Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

### –õ–æ–≥—É–≤–∞–Ω–Ω—è

–í—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å `log()` —ñ `error()` ‚Äî –ø–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ –ª–æ–≥–∏ –≤:
**Functions ‚Üí [function] ‚Üí Executions**

### –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥

–°–ª—ñ–¥–∫—É–π—Ç–µ –∑–∞:

- –ü–æ–º–∏–ª–∫–∞–º–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–π
- –ù–µ–∑–≤–∏—á–∞–π–Ω–æ —á–∞—Å—Ç–∏–º–∏ –∑–∞–ø–∏—Ç–∞–º–∏ (–º–æ–∂–ª–∏–≤–∏–π –±–æ—Ç)
- –î–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –∑ –∞–Ω–æ–º–∞–ª—å–Ω–∏–º–∏ —Ä–∞—Ö—É–Ω–∫–∞–º–∏

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—ñ–≤

```
functions/
‚îú‚îÄ‚îÄ game-make-move/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ src/main.js         # –•—ñ–¥ —É –∫–ª–∞—Å–∏—á–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ
‚îú‚îÄ‚îÄ game-make-race-move/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ src/main.js         # –•—ñ–¥ —É —Ä–µ–∂–∏–º—ñ race
‚îú‚îÄ‚îÄ game-start/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ src/main.js         # –°—Ç–∞—Ä—Ç –≥—Ä–∏ (–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –¥–æ—à–∫–∏)
‚îú‚îÄ‚îÄ lobby-create/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ src/main.js         # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–æ–±—ñ
‚îú‚îÄ‚îÄ lobby-join/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ src/main.js         # –ü—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ –ª–æ–±—ñ
‚îú‚îÄ‚îÄ lobby-leave/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ src/main.js         # –í–∏—Ö—ñ–¥ –∑ –ª–æ–±—ñ
‚îú‚îÄ‚îÄ game-leave/
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ src/main.js         # –ó–¥–∞—á–∞ –≥—Ä–∏
‚îî‚îÄ‚îÄ cleanup-stale/
    ‚îú‚îÄ‚îÄ package.json
    ‚îî‚îÄ‚îÄ src/main.js         # CRON: –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–∏—Ö –ª–æ–±—ñ/—ñ–≥–æ—Ä
```
